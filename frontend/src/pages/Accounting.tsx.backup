import React, { useEffect, useState } from 'react';
import {
  Box,
  Typography,
  Button,
  Chip,
  IconButton,
  CircularProgress,
  Card,
  CardContent,
  Grid,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Paper,
  alpha,
  Menu,
  MenuItem,
  Tabs,
  Tab,
  TextField,
  InputAdornment
} from '@mui/material';
import {
  Add as AddIcon,
  MoreVert as MoreVertIcon,
  AccountBalance as AccountBalanceIcon,
  TrendingUp as TrendingUpIcon,
  TrendingDown as TrendingDownIcon,
  SwapHoriz as SwapHorizIcon,
  Search as SearchIcon,
  CheckCircle as CheckCircleIcon,
  Pending as PendingIcon,
  Cancel as CancelIcon,
  AttachMoney as MoneyIcon
} from '@mui/icons-material';
import { useTheme as useCustomTheme } from '../contexts/ThemeContext';
import accountingService from '../services/accountingService';
import { Account, Transaction } from '../types/accounting';
import { format } from 'date-fns';
import { es } from 'date-fns/locale';
import { useNavigate } from 'react-router-dom';

interface TabPanelProps {
  children?: React.ReactNode;
  index: number;
  value: number;
}

const TabPanel: React.FC<TabPanelProps> = ({ children, value, index }) => {
  return (
    <div role="tabpanel" hidden={value !== index}>
      {value === index && <Box sx={{ py: 3 }}>{children}</Box>}
    </div>
  );
};

const Accounting: React.FC = () => {
  const { isDarkMode } = useCustomTheme();
  const navigate = useNavigate();
  const [accounts, setAccounts] = useState<Account[]>([]);
  const [transactions, setTransactions] = useState<Transaction[]>([]);
  const [loading, setLoading] = useState(true);
  const [tabValue, setTabValue] = useState(0);
  const [anchorEl, setAnchorEl] = useState<null | HTMLElement>(null);
  const [selectedItem, setSelectedItem] = useState<any>(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [accountTypeFilter, setAccountTypeFilter] = useState<string>('all');
  const [balanceData, setBalanceData] = useState<any>(null);

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    try {
      const [accountsRes, transactionsRes, balanceRes] = await Promise.all([
        accountingService.getAccounts(),
        accountingService.getTransactions(),
        accountingService.getBalanceSheet()
      ]);

      setAccounts(accountsRes.data);
      setTransactions(transactionsRes.data);
      setBalanceData(balanceRes.data);
    } catch (error) {
      console.error('Error loading accounting data:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleMenuOpen = (event: React.MouseEvent<HTMLElement>, item: any) => {
    setAnchorEl(event.currentTarget);
    setSelectedItem(item);
  };

  const handleMenuClose = () => {
    setAnchorEl(null);
    setSelectedItem(null);
  };

  const handleApprove = async (id: number) => {
    try {
      await accountingService.approveTransaction(id);
      loadData();
      handleMenuClose();
    } catch (error) {
      console.error('Error approving transaction:', error);
    }
  };

  const handleCancel = async (id: number) => {
    try {
      await accountingService.cancelTransaction(id);
      loadData();
      handleMenuClose();
    } catch (error) {
      console.error('Error canceling transaction:', error);
    }
  };

  const getAccountTypeConfig = (type: string) => {
    const configs: any = {
      asset: { label: 'Activo', color: '#10b981', icon: <TrendingUpIcon /> },
      liability: { label: 'Pasivo', color: '#ef4444', icon: <TrendingDownIcon /> },
      equity: { label: 'Patrimonio', color: '#8b5cf6', icon: <AccountBalanceIcon /> },
      income: { label: 'Ingreso', color: '#3b82f6', icon: <MoneyIcon /> },
      expense: { label: 'Gasto', color: '#f59e0b', icon: <SwapHorizIcon /> }
    };
    return configs[type] || configs.asset;
  };

  const getTransactionStatusChip = (status: string) => {
    const configs: any = {
      pending: { label: 'Pendiente', color: '#f59e0b', icon: <PendingIcon /> },
      approved: { label: 'Aprobada', color: '#10b981', icon: <CheckCircleIcon /> },
      cancelled: { label: 'Cancelada', color: '#ef4444', icon: <CancelIcon /> }
    };
    const config = configs[status] || configs.pending;

    return (
      <Chip
        label={config.label}
        icon={config.icon}
        size="small"
        sx={{
          bgcolor: alpha(config.color, 0.1),
          color: config.color,
          border: 'none',
          '& .MuiChip-icon': { color: config.color }
        }}
      />
    );
  };

  const getTransactionTypeIcon = (type: string) => {
    const icons: any = {
      income: <TrendingUpIcon sx={{ color: '#10b981' }} />,
      expense: <TrendingDownIcon sx={{ color: '#ef4444' }} />,
      transfer: <SwapHorizIcon sx={{ color: '#3b82f6' }} />
    };
    return icons[type] || icons.transfer;
  };

  const filteredAccounts = accounts.filter(account => {
    const matchesSearch = account.accountName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         account.accountCode.toLowerCase().includes(searchTerm.toLowerCase());
    const matchesType = accountTypeFilter === 'all' || account.accountType === accountTypeFilter;
    return matchesSearch && matchesType;
  });

  const filteredTransactions = transactions.filter(transaction =>
    transaction.transactionCode.toLowerCase().includes(searchTerm.toLowerCase()) ||
    transaction.description?.toLowerCase().includes(searchTerm.toLowerCase())
  );

  if (loading) {
    return (
      <Box sx={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100vh' }}>
        <CircularProgress />
      </Box>
    );
  }

  const totalAssets = balanceData?.totalAssets || 0;
  const totalLiabilities = balanceData?.totalLiabilities || 0;
  const totalEquity = balanceData?.totalEquity || 0;
  const pendingTransactions = transactions.filter(t => t.status === 'pending').length;

  return (
    <Box>
      {/* Header */}
      <Box sx={{ mb: 4, display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
        <Box>
          <Typography variant="h3" fontWeight="700" sx={{ fontSize: '2rem', letterSpacing: '-0.02em', mb: 0.5 }}>
            Contabilidad
          </Typography>
          <Typography variant="body2" color="text.secondary" sx={{ fontSize: '0.875rem' }}>
            Gestión de cuentas y transacciones financieras
          </Typography>
        </Box>

        <Button
          variant="contained"
          startIcon={<AddIcon />}
          onClick={() => navigate('/accounting/transaction/new')}
          sx={{
            bgcolor: isDarkMode ? '#8b5cf6' : '#8b5cf6',
            color: '#fff',
            '&:hover': {
              bgcolor: isDarkMode ? '#7c3aed' : '#7c3aed'
            }
          }}
        >
          Nueva Transacción
        </Button>
      </Box>

      {/* Stats Cards */}
      <Grid container spacing={2} sx={{ mb: 4 }}>
        <Grid item xs={12} sm={6} md={3}>
          <Card>
            <CardContent>
              <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                <Box>
                  <Typography variant="body2" color="text.secondary" gutterBottom>
                    Activos Totales
                  </Typography>
                  <Typography variant="h4" fontWeight="bold" sx={{ color: '#10b981' }}>
                    ${totalAssets.toLocaleString()}
                  </Typography>
                </Box>
                <TrendingUpIcon sx={{ fontSize: 40, color: '#10b981', opacity: 0.5 }} />
              </Box>
            </CardContent>
          </Card>
        </Grid>

        <Grid item xs={12} sm={6} md={3}>
          <Card>
            <CardContent>
              <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                <Box>
                  <Typography variant="body2" color="text.secondary" gutterBottom>
                    Pasivos Totales
                  </Typography>
                  <Typography variant="h4" fontWeight="bold" sx={{ color: '#ef4444' }}>
                    ${totalLiabilities.toLocaleString()}
                  </Typography>
                </Box>
                <TrendingDownIcon sx={{ fontSize: 40, color: '#ef4444', opacity: 0.5 }} />
              </Box>
            </CardContent>
          </Card>
        </Grid>

        <Grid item xs={12} sm={6} md={3}>
          <Card>
            <CardContent>
              <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                <Box>
                  <Typography variant="body2" color="text.secondary" gutterBottom>
                    Patrimonio
                  </Typography>
                  <Typography variant="h4" fontWeight="bold" sx={{ color: '#8b5cf6' }}>
                    ${totalEquity.toLocaleString()}
                  </Typography>
                </Box>
                <AccountBalanceIcon sx={{ fontSize: 40, color: '#8b5cf6', opacity: 0.5 }} />
              </Box>
            </CardContent>
          </Card>
        </Grid>

        <Grid item xs={12} sm={6} md={3}>
          <Card>
            <CardContent>
              <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                <Box>
                  <Typography variant="body2" color="text.secondary" gutterBottom>
                    Transacciones Pendientes
                  </Typography>
                  <Typography variant="h4" fontWeight="bold" sx={{ color: '#f59e0b' }}>
                    {pendingTransactions}
                  </Typography>
                </Box>
                <PendingIcon sx={{ fontSize: 40, color: '#f59e0b', opacity: 0.5 }} />
              </Box>
            </CardContent>
          </Card>
        </Grid>
      </Grid>

      {/* Tabs */}
      <Card sx={{ mb: 3 }}>
        <Tabs
          value={tabValue}
          onChange={(e, newValue) => setTabValue(newValue)}
          sx={{
            borderBottom: 1,
            borderColor: 'divider',
            '& .MuiTab-root': {
              textTransform: 'none',
              fontWeight: 600
            }
          }}
        >
          <Tab label="Catálogo de Cuentas" />
          <Tab label="Transacciones" />
        </Tabs>
      </Card>

      {/* Search and Filters */}
      <Card sx={{ mb: 3, p: 2 }}>
        <Grid container spacing={2} alignItems="center">
          <Grid item xs={12} md={6}>
            <TextField
              fullWidth
              size="small"
              placeholder="Buscar por código, nombre o descripción..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              InputProps={{
                startAdornment: (
                  <InputAdornment position="start">
                    <SearchIcon />
                  </InputAdornment>
                )
              }}
            />
          </Grid>
          {tabValue === 0 && (
            <Grid item xs={12} md={6}>
              <Box sx={{ display: 'flex', gap: 1, flexWrap: 'wrap' }}>
                <Button
                  size="small"
                  variant={accountTypeFilter === 'all' ? 'contained' : 'outlined'}
                  onClick={() => setAccountTypeFilter('all')}
                >
                  Todas
                </Button>
                <Button
                  size="small"
                  variant={accountTypeFilter === 'asset' ? 'contained' : 'outlined'}
                  onClick={() => setAccountTypeFilter('asset')}
                  sx={{ color: accountTypeFilter === 'asset' ? '#fff' : '#10b981' }}
                >
                  Activos
                </Button>
                <Button
                  size="small"
                  variant={accountTypeFilter === 'liability' ? 'contained' : 'outlined'}
                  onClick={() => setAccountTypeFilter('liability')}
                  sx={{ color: accountTypeFilter === 'liability' ? '#fff' : '#ef4444' }}
                >
                  Pasivos
                </Button>
                <Button
                  size="small"
                  variant={accountTypeFilter === 'equity' ? 'contained' : 'outlined'}
                  onClick={() => setAccountTypeFilter('equity')}
                  sx={{ color: accountTypeFilter === 'equity' ? '#fff' : '#8b5cf6' }}
                >
                  Patrimonio
                </Button>
                <Button
                  size="small"
                  variant={accountTypeFilter === 'income' ? 'contained' : 'outlined'}
                  onClick={() => setAccountTypeFilter('income')}
                  sx={{ color: accountTypeFilter === 'income' ? '#fff' : '#3b82f6' }}
                >
                  Ingresos
                </Button>
                <Button
                  size="small"
                  variant={accountTypeFilter === 'expense' ? 'contained' : 'outlined'}
                  onClick={() => setAccountTypeFilter('expense')}
                  sx={{ color: accountTypeFilter === 'expense' ? '#fff' : '#f59e0b' }}
                >
                  Gastos
                </Button>
              </Box>
            </Grid>
          )}
        </Grid>
      </Card>

      {/* Accounts Tab */}
      <TabPanel value={tabValue} index={0}>
        <TableContainer component={Paper}>
          <Table>
            <TableHead>
              <TableRow sx={{ bgcolor: isDarkMode ? 'rgba(139, 92, 246, 0.1)' : alpha('#8b5cf6', 0.1) }}>
                <TableCell sx={{ fontWeight: 700 }}>Código</TableCell>
                <TableCell sx={{ fontWeight: 700 }}>Nombre de Cuenta</TableCell>
                <TableCell sx={{ fontWeight: 700 }}>Tipo</TableCell>
                <TableCell sx={{ fontWeight: 700 }}>Saldo</TableCell>
                <TableCell sx={{ fontWeight: 700 }}>Estado</TableCell>
                <TableCell sx={{ fontWeight: 700 }} align="right">Acciones</TableCell>
              </TableRow>
            </TableHead>
            <TableBody>
              {filteredAccounts.length === 0 ? (
                <TableRow>
                  <TableCell colSpan={6} align="center" sx={{ py: 8 }}>
                    <Typography variant="body2" color="text.secondary">
                      No se encontraron cuentas
                    </Typography>
                  </TableCell>
                </TableRow>
              ) : (
                filteredAccounts.map((account) => {
                  const typeConfig = getAccountTypeConfig(account.accountType);
                  return (
                    <TableRow key={account.id} hover>
                      <TableCell>
                        <Typography variant="body2" fontWeight={600}>
                          {account.accountCode}
                        </Typography>
                      </TableCell>
                      <TableCell>
                        <Typography variant="body2">{account.accountName}</Typography>
                        {account.description && (
                          <Typography variant="caption" color="text.secondary">
                            {account.description}
                          </Typography>
                        )}
                      </TableCell>
                      <TableCell>
                        <Chip
                          label={typeConfig.label}
                          icon={typeConfig.icon}
                          size="small"
                          sx={{
                            bgcolor: alpha(typeConfig.color, 0.1),
                            color: typeConfig.color,
                            border: 'none',
                            '& .MuiChip-icon': { color: typeConfig.color }
                          }}
                        />
                      </TableCell>
                      <TableCell>
                        <Typography variant="body2" fontWeight={600}>
                          ${account.balance.toLocaleString()}
                        </Typography>
                      </TableCell>
                      <TableCell>
                        <Chip
                          label={account.isActive ? 'Activa' : 'Inactiva'}
                          size="small"
                          color={account.isActive ? 'success' : 'default'}
                        />
                      </TableCell>
                      <TableCell align="right">
                        <IconButton
                          size="small"
                          onClick={(e) => handleMenuOpen(e, account)}
                        >
                          <MoreVertIcon />
                        </IconButton>
                      </TableCell>
                    </TableRow>
                  );
                })
              )}
            </TableBody>
          </Table>
        </TableContainer>
      </TabPanel>

      {/* Transactions Tab */}
      <TabPanel value={tabValue} index={1}>
        <TableContainer component={Paper}>
          <Table>
            <TableHead>
              <TableRow sx={{ bgcolor: isDarkMode ? 'rgba(139, 92, 246, 0.1)' : alpha('#8b5cf6', 0.1) }}>
                <TableCell sx={{ fontWeight: 700 }}>Código</TableCell>
                <TableCell sx={{ fontWeight: 700 }}>Fecha</TableCell>
                <TableCell sx={{ fontWeight: 700 }}>Tipo</TableCell>
                <TableCell sx={{ fontWeight: 700 }}>Descripción</TableCell>
                <TableCell sx={{ fontWeight: 700 }}>Monto</TableCell>
                <TableCell sx={{ fontWeight: 700 }}>Estado</TableCell>
                <TableCell sx={{ fontWeight: 700 }} align="right">Acciones</TableCell>
              </TableRow>
            </TableHead>
            <TableBody>
              {filteredTransactions.length === 0 ? (
                <TableRow>
                  <TableCell colSpan={7} align="center" sx={{ py: 8 }}>
                    <Typography variant="body2" color="text.secondary">
                      No se encontraron transacciones
                    </Typography>
                  </TableCell>
                </TableRow>
              ) : (
                filteredTransactions.map((transaction) => (
                  <TableRow key={transaction.id} hover>
                    <TableCell>
                      <Typography variant="body2" fontWeight={600}>
                        {transaction.transactionCode}
                      </Typography>
                    </TableCell>
                    <TableCell>
                      <Typography variant="body2">
                        {format(new Date(transaction.transactionDate), "d MMM yyyy", { locale: es })}
                      </Typography>
                    </TableCell>
                    <TableCell>
                      <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                        {getTransactionTypeIcon(transaction.transactionType)}
                        <Typography variant="body2" sx={{ textTransform: 'capitalize' }}>
                          {transaction.transactionType}
                        </Typography>
                      </Box>
                    </TableCell>
                    <TableCell>
                      <Typography variant="body2">{transaction.description || '-'}</Typography>
                    </TableCell>
                    <TableCell>
                      <Typography variant="body2" fontWeight={600}>
                        ${transaction.amount.toLocaleString()}
                      </Typography>
                    </TableCell>
                    <TableCell>
                      {getTransactionStatusChip(transaction.status)}
                    </TableCell>
                    <TableCell align="right">
                      <IconButton
                        size="small"
                        onClick={(e) => handleMenuOpen(e, transaction)}
                      >
                        <MoreVertIcon />
                      </IconButton>
                    </TableCell>
                  </TableRow>
                ))
              )}
            </TableBody>
          </Table>
        </TableContainer>
      </TabPanel>

      {/* Context Menu */}
      <Menu
        anchorEl={anchorEl}
        open={Boolean(anchorEl)}
        onClose={handleMenuClose}
      >
        {selectedItem && 'status' in selectedItem && (
          <>
            {selectedItem.status === 'pending' && (
              <MenuItem onClick={() => handleApprove(selectedItem.id)}>
                <CheckCircleIcon sx={{ mr: 1, fontSize: 20, color: '#10b981' }} />
                Aprobar
              </MenuItem>
            )}
            {selectedItem.status !== 'cancelled' && (
              <MenuItem onClick={() => handleCancel(selectedItem.id)}>
                <CancelIcon sx={{ mr: 1, fontSize: 20, color: '#ef4444' }} />
                Cancelar
              </MenuItem>
            )}
          </>
        )}
        <MenuItem onClick={handleMenuClose}>
          <SearchIcon sx={{ mr: 1, fontSize: 20 }} />
          Ver Detalles
        </MenuItem>
      </Menu>
    </Box>
  );
};

export default Accounting;
